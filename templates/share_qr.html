<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share UPI QR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body class="text-center p-4 bg-light">

    <h4 class="mb-3">Your UPI QR Code</h4>
    <img id="qrImage" src="data:image/png;base64,{{ qr_base64 }}" alt="UPI QR" class="img-fluid rounded shadow"
        width="250">

    <p class="mt-3">
        <b>UPI ID:</b> {{ upi_id }}<br>
        <b>UPI Link:</b> <span class="text-primary">{{ upi_link }}</span>
    </p>

    <button class="btn btn-success mt-3" id="shareBtn">Share QR + Link</button>
    <!-- <button class="btn btn-success mt-3" id="downloadBtn">Download QR</button> -->
    <a href="{{ url_for('profile') }}" class="btn btn-secondary btn-sm mt-3">
        ‚Üê Back to Profile
    </a>

    <script>
        document.getElementById("shareBtn").addEventListener("click", async () => {
            const qrBase64 = document.getElementById("qrImage").src.split(",")[1];
            const blob = await (await fetch("data:image/png;base64," + qrBase64)).blob();
            const file = new File([blob], "upi_qr.png", { type: "image/png" });

            const upiLink = "{{ upi_link }}";
            const shareText = `Here's my UPI ID: {{ upi_id }}\nPay using this link: ${upiLink}`;

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: "PayShield UPI QR",
                        text: shareText,
                        files: [file]
                    });
                } catch (err) {
                    console.error("Sharing canceled or failed:", err);
                    alert("Sharing canceled or not supported on this device.");
                }
            } else {
                alert("Your browser does not support image sharing. Please download the QR manually.");
            }
        });

        // Download fallback
        document.getElementById("downloadBtn").addEventListener("click", () => {
            const a = document.createElement("a");
            a.href = document.getElementById("qrImage").src;
            a.download = "upi_qr.png";
            a.click();
        });
    </script>
</body>

</html>